<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Prestador de Serviço</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1100px;
      margin: 30px auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      padding: 30px 20px;
    }
    h1 {
      text-align: center;
      color: #2d3e50;
      margin-bottom: 30px;
    }
    form {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
      justify-content: space-between;
    }
    .form-group {
      flex: 1 1 220px;
      min-width: 220px;
      display: flex;
      flex-direction: column;
    }
    label {
      font-weight: 700;
      margin-bottom: 5px;
      color: #34495e;
    }
    input, select {
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1em;
      background: #f9f9f9;
    }
    .photo-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-start;
    }
    .photo-preview {
      width: 120px;
      height: 90px;
      object-fit: cover;
      border: 1px solid #ccc;
      border-radius: 5px;
      background: #eee;
      margin-top: 5px;
    }
    .actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    button, .btn {
      background: #1976d2;
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 5px;
      font-size: 1em;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover, .btn:hover {
      background: #125ea2;
    }
    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .search-bar input {
      flex: 1 1 200px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #fff;
    }
    th, td {
      padding: 8px 6px;
      border: 1px solid #e0e0e0;
      text-align: left;
      font-size: 0.98em;
    }
    th {
      background: #1976d2;
      color: #fff;
    }
    tr:nth-child(even) {
      background: #f4f6f8;
    }
    .btn-baixa {
      background: #e53935;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.95em;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-baixa:hover {
      background: #b71c1c;
    }
    .img-ampliada-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .img-ampliada-bg img {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 10px;
      box-shadow: 0 2px 20px #000a;
      background: #fff;
      padding: 8px;
    }
    .img-ampliada-bg .fechar {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 2em;
      color: #fff;
      background: none;
      border: none;
      cursor: pointer;
      z-index: 10000;
    }
    @media (max-width: 800px) {
      .container { padding: 10px 2px; }
      form { flex-direction: column; gap: 10px; }
      .form-group { min-width: 100%; }
      .search-bar { flex-direction: column; gap: 5px; }
      table, th, td { font-size: 0.92em; }
      .photo-preview, video { width: 100% !important; height: auto !important; }
      #loginModal > div { flex-direction: column !important; gap: 10px !important; }
      #loginModal form { min-width: 90vw !important; }
    }
    @media (max-width: 500px) {
      .container { padding: 2px 0; }
      h1 { font-size: 1.2em; }
      button, .btn { font-size: 0.95em; padding: 8px 10px; }
      th, td { padding: 4px 2px; }
      #loginModal form { min-width: 98vw !important; padding: 10px 2px !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Cadastro de Prestador de Serviço</h1>
    <form id="cadastroForm" autocomplete="off">
      <div class="form-group">
        <label for="apartamento">Apartamento</label>
        <input type="text" id="apartamento" required>
      </div>
      <div class="form-group">
        <label for="nome">Nome</label>
        <input type="text" id="nome" required>
      </div>
      <div class="form-group">
        <label for="documento">Documento</label>
        <input type="text" id="documento" required>
      </div>
      <div class="form-group">
        <label for="autorizador">Nome de quem autoriza</label>
        <input type="text" id="autorizador" required>
      </div>
      <div class="form-group">
        <label for="entrada">Data/Hora Entrada</label>
        <input type="datetime-local" id="entrada" required>
      </div>
      <div class="form-group">
        <label for="saida">Data/Hora Saída</label>
        <input type="datetime-local" id="saida">
      </div>
      <div class="form-group">
        <label for="empresa">Empresa</label>
        <input type="text" id="empresa" required>
      </div>
      <div class="form-group">
        <label for="servico">Serviço</label>
        <input type="text" id="servico" required>
      </div>
      <div class="form-group photo-section">
        <label>Foto Frente</label>
        <video id="videoFrente" width="120" height="90" autoplay playsinline style="display:none;"></video>
        <img id="fotoFrentePreview" class="photo-preview" src="" alt="Foto Frente" onclick="ampliarFoto(this)">
        <div class="actions">
          <button type="button" onclick="abrirCamera('frente')">Abrir Câmera</button>
          <button type="button" onclick="tirarFoto('frente')">Tirar Foto</button>
          <input type="file" accept="image/*" style="display:none;" id="fileFrente" onchange="carregarArquivoFoto(event, 'frente')">
          <button type="button" onclick="document.getElementById('fileFrente').click()">Arquivo</button>
        </div>
      </div>
      <div class="form-group photo-section">
        <label>Foto Verso</label>
        <video id="videoVerso" width="120" height="90" autoplay playsinline style="display:none;"></video>
        <img id="fotoVersoPreview" class="photo-preview" src="" alt="Foto Verso" onclick="ampliarFoto(this)">
        <div class="actions">
          <button type="button" onclick="abrirCamera('verso')">Abrir Câmera</button>
          <button type="button" onclick="tirarFoto('verso')">Tirar Foto</button>
          <input type="file" accept="image/*" style="display:none;" id="fileVerso" onchange="carregarArquivoFoto(event, 'verso')">
          <button type="button" onclick="document.getElementById('fileVerso').click()">Arquivo</button>
        </div>
      </div>
      <div class="form-group">
        <label for="cameraSelect">Câmera</label>
        <select id="cameraSelect"></select>
      </div>
      <div class="form-group" style="align-self: flex-end;">
        <button type="submit">Cadastrar</button>
      </div>
    </form>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Buscar por nome ou documento...">
      <button type="button" onclick="buscarPorNomeOuDocumento()">Buscar</button>
      <button type="button" onclick="exportarCSV()">Exportar CSV</button>
      <button type="button" onclick="exportarPDF()">Exportar PDF</button>
      <button type="button" onclick="salvarPrestadores()" style="background:#388e3c;">Salvar Registros</button>
      <button type="button" onclick="abrirRelatorio()" style="background:#ff9800;">Relatório</button>
    </div>
    <div style="overflow-x:auto;">
      <table id="tabelaPrestadores">
        <thead>
          <tr>
            <th>Apto</th>
            <th>Nome</th>
            <th>Documento</th>
            <th>Autorizador</th>
            <th>Entrada</th>
            <th>Saída</th>
            <th>Empresa</th>
            <th>Serviço</th>
            <th>Foto Frente</th>
            <th>Foto Verso</th>
            <th>Baixa</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let streamAtual = null;
    let facingModeAtual = 'environment';
    let cameras = [];
    let fotoFrente = '';
    let fotoVerso = '';
    let prestadores = [];

    // Função para obter a chave de storage do usuário
    function storageKey() {
      return 'prestadores';
    }

    // Salvar no localStorage
    function salvarPrestadores() {
      localStorage.setItem(storageKey(), JSON.stringify(prestadores));
    }

    // Carregar do localStorage
    function carregarPrestadores() {
      const dados = localStorage.getItem(storageKey());
      prestadores = dados ? JSON.parse(dados) : [];
    }

    // Carregar câmeras disponíveis
    async function carregarCameras() {
      const select = document.getElementById('cameraSelect');
      select.innerHTML = '';
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        cameras = devices.filter(d => d.kind === 'videoinput');
        // Prioriza traseira (environment) no topo da lista
        cameras.sort((a, b) => {
          if (a.label.toLowerCase().includes('back') || a.label.toLowerCase().includes('traseira') || a.label.toLowerCase().includes('environment')) return -1;
          if (b.label.toLowerCase().includes('back') || b.label.toLowerCase().includes('traseira') || b.label.toLowerCase().includes('environment')) return 1;
          return 0;
        });
        cameras.forEach((cam, i) => {
          const opt = document.createElement('option');
          opt.value = cam.deviceId;
          opt.text = cam.label || `Câmera ${i+1}`;
          select.appendChild(opt);
        });
        // Seleciona automaticamente a traseira se existir
        const traseira = cameras.find(cam => cam.label.toLowerCase().includes('back') || cam.label.toLowerCase().includes('traseira') || cam.label.toLowerCase().includes('environment'));
        if (traseira) select.value = traseira.deviceId;
      } catch (e) {
        select.innerHTML = '<option>Não disponível</option>';
      }
    }

    // Abrir câmera
    async function abrirCamera(tipo) {
      if (streamAtual) {
        streamAtual.getTracks().forEach(track => track.stop());
      }
      const select = document.getElementById('cameraSelect');
      const deviceId = select.value;
      let constraints = {};
      if (deviceId) {
        constraints = { video: { deviceId: { exact: deviceId } } };
      } else {
        // fallback para traseira em mobile
        constraints = { video: { facingMode: { exact: 'environment' } } };
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        streamAtual = stream;
        const video = tipo === 'frente' ? document.getElementById('videoFrente') : document.getElementById('videoVerso');
        video.srcObject = stream;
        video.style.display = 'block';
        video.play();
      } catch (e) {
        alert('Erro ao acessar a câmera!');
      }
    }

    // Tirar foto
    function tirarFoto(tipo) {
      const video = tipo === 'frente' ? document.getElementById('videoFrente') : document.getElementById('videoVerso');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth || 120;
      canvas.height = video.videoHeight || 90;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/jpeg');
      if (tipo === 'frente') {
        fotoFrente = dataUrl;
        document.getElementById('fotoFrentePreview').src = dataUrl;
      } else {
        fotoVerso = dataUrl;
        document.getElementById('fotoVersoPreview').src = dataUrl;
      }
      video.style.display = 'none';
      if (streamAtual) {
        streamAtual.getTracks().forEach(track => track.stop());
        streamAtual = null;
      }
    }

    // Renderizar tabela
    function renderizarTabela(filtro = '') {
      const tbody = document.querySelector('#tabelaPrestadores tbody');
      tbody.innerHTML = '';
      let lista = prestadores;
      if (filtro) {
        const f = filtro.toLowerCase();
        lista = lista.filter(p => p.nome.toLowerCase().includes(f) || p.documento.toLowerCase().includes(f));
      }
      lista.forEach((p, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.apartamento}</td>
          <td>${p.nome}</td>
          <td>${p.documento}</td>
          <td>${p.autorizador}</td>
          <td>${p.entrada}</td>
          <td>${p.saida || ''}</td>
          <td>${p.empresa}</td>
          <td>${p.servico}</td>
          <td>${p.fotoFrente ? `<img src="${p.fotoFrente}" style="width:40px;height:30px;object-fit:cover;border-radius:3px;cursor:pointer;" onclick="ampliarFoto(this)">` : ''}</td>
          <td>${p.fotoVerso ? `<img src="${p.fotoVerso}" style="width:40px;height:30px;object-fit:cover;border-radius:3px;cursor:pointer;" onclick="ampliarFoto(this)">` : ''}</td>
          <td>${!p.saida ? `<button class='btn-baixa' onclick='darBaixa(${idx})'>Dar Baixa</button>` : ''}
              <button class='btn' style='background:#1976d2;margin-left:4px;' onclick='editarPrestador(${idx})'>Editar</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Dar baixa
    function darBaixa(idx) {
      const data = new Date();
      prestadores[idx].saida = data.toISOString().slice(0,16).replace('T',' ');
      salvarPrestadores();
      renderizarTabela(document.getElementById('searchInput').value);
    }

    // Cadastrar prestador
    document.getElementById('cadastroForm').onsubmit = function(e) {
      e.preventDefault();
      const novo = {
        apartamento: document.getElementById('apartamento').value,
        nome: document.getElementById('nome').value,
        documento: document.getElementById('documento').value,
        autorizador: document.getElementById('autorizador').value,
        entrada: document.getElementById('entrada').value.replace('T',' '),
        saida: document.getElementById('saida').value ? document.getElementById('saida').value.replace('T',' ') : '',
        empresa: document.getElementById('empresa').value,
        servico: document.getElementById('servico').value,
        fotoFrente,
        fotoVerso
      };
      prestadores.push(novo);
      salvarPrestadores();
      renderizarTabela(document.getElementById('searchInput').value);
      document.getElementById('cadastroForm').reset();
      fotoFrente = '';
      fotoVerso = '';
      document.getElementById('fotoFrentePreview').src = '';
      document.getElementById('fotoVersoPreview').src = '';
      // Limpa campos de data/hora para evitar valores antigos
      document.getElementById('entrada').value = '';
      document.getElementById('saida').value = '';
    };

    // Busca
    document.getElementById('searchInput').oninput = function() {
      renderizarTabela(this.value);
    };

    // Botão de busca
    function buscarPorNomeOuDocumento() {
      const valor = document.getElementById('searchInput').value;
      renderizarTabela(valor);
    }

    // Exportar CSV
    function exportarCSV() {
      let csv = 'Apartamento,Nome,Documento,Autorizador,Entrada,Saida,Empresa,Servico\n';
      prestadores.forEach(p => {
        csv += `"${p.apartamento}","${p.nome}","${p.documento}","${p.autorizador}","${p.entrada}","${p.saida}","${p.empresa}","${p.servico}"
`;
      });
      const blob = new Blob([csv], {type: 'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'prestadores.csv';
      a.click();
    }

    // Exportar PDF
    function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(12);
      doc.text('Prestadores de Serviço', 10, 10);
      let y = 20;
      prestadores.forEach((p, i) => {
        doc.text(`${i+1}. ${p.nome} | ${p.documento} | ${p.apartamento} | ${p.entrada} | ${p.saida || ''}`, 10, y);
        y += 8;
        if (y > 270) { doc.addPage(); y = 20; }
      });
      doc.save('prestadores.pdf');
    }

    // Ampliar foto
    function ampliarFoto(img) {
      if (!img.src) return;
      const bg = document.createElement('div');
      bg.className = 'img-ampliada-bg';
      bg.innerHTML = `<button class='fechar' onclick='this.parentNode.remove()' title='Fechar'>&times;</button><img src='${img.src}' alt='Foto Ampliada'>`;
      document.body.appendChild(bg);
      bg.onclick = function(e) { if (e.target === bg) bg.remove(); };
    }

    // Carregar arquivo de foto
    function carregarArquivoFoto(event, tipo) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        if (tipo === 'frente') {
          fotoFrente = e.target.result;
          document.getElementById('fotoFrentePreview').src = fotoFrente;
        } else {
          fotoVerso = e.target.result;
          document.getElementById('fotoVersoPreview').src = fotoVerso;
        }
      };
      reader.readAsDataURL(file);
    }

    // Função para abrir relatório em nova janela
    function abrirRelatorio() {
      let rel = window.open('', '_blank');
      rel.document.write('<html><head><title>Relatório de Prestadores</title><style>body{font-family:sans-serif;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ccc;padding:6px;}th{background:#1976d2;color:#fff;}tr:nth-child(even){background:#f4f6f8;}</style></head><body>');
      rel.document.write('<h2>Relatório de Prestadores de Serviço</h2>');
      rel.document.write('<table><thead><tr><th>Apto</th><th>Nome</th><th>Documento</th><th>Autorizador</th><th>Entrada</th><th>Saída</th><th>Empresa</th><th>Serviço</th></tr></thead><tbody>');
      prestadores.forEach(p => {
        rel.document.write(`<tr><td>${p.apartamento}</td><td>${p.nome}</td><td>${p.documento}</td><td>${p.autorizador}</td><td>${p.entrada}</td><td>${p.saida || ''}</td><td>${p.empresa}</td><td>${p.servico}</td></tr>`);
      });
      rel.document.write('</tbody></table></body></html>');
      rel.document.close();
    }

    // Função para editar prestador
    function editarPrestador(idx) {
      const p = prestadores[idx];
      document.getElementById('apartamento').value = p.apartamento;
      document.getElementById('nome').value = p.nome;
      document.getElementById('documento').value = p.documento;
      document.getElementById('autorizador').value = p.autorizador;
      document.getElementById('entrada').value = p.entrada.replace(' ', 'T');
      document.getElementById('saida').value = p.saida ? p.saida.replace(' ', 'T') : '';
      document.getElementById('empresa').value = p.empresa;
      document.getElementById('servico').value = p.servico;
      fotoFrente = p.fotoFrente;
      fotoVerso = p.fotoVerso;
      document.getElementById('fotoFrentePreview').src = fotoFrente;
      document.getElementById('fotoVersoPreview').src = fotoVerso;
      // Remove o registro antigo para evitar duplicidade ao salvar
      prestadores.splice(idx, 1);
      salvarPrestadores();
      renderizarTabela(document.getElementById('searchInput').value);
    }

    // Inicialização
    window.onload = async function() {
      await carregarCameras();
      carregarPrestadores();
      renderizarTabela();
    };
  </script>
</body>
</html>
